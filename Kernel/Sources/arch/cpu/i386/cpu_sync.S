;-------------------------------------------------------------------------------
;
; File: cpu_sync.S
;
; Author: Alexy Torres Aurora Dugo
;
; Date: 14/12/2017
;
; Version: 1.0
;
; CPU synchronization functions
;-------------------------------------------------------------------------------
;-------------------------------------------------------------------------------
; ARCH
;-------------------------------------------------------------------------------
[bits 32]

;-------------------------------------------------------------------------------
; DEFINES
;-------------------------------------------------------------------------------

;-------------------------------------------------------------------------------
; MACRO DEFINE
;-------------------------------------------------------------------------------

;-------------------------------------------------------------------------------
; EXTERN DATA
;-------------------------------------------------------------------------------

;-------------------------------------------------------------------------------
; EXTERN FUNCTIONS
;-------------------------------------------------------------------------------

;-------------------------------------------------------------------------------
; EXPORTED FUNCTIONS
;-------------------------------------------------------------------------------
global __pause_spinlock

;-------------------------------------------------------------------------------
; CODE
;-------------------------------------------------------------------------------

section .text
;-------------------------------------------------------------------------------
; Pause Spinlock
;
; Param:
;     Input: ESP + 4: Address of the lock

__pause_spinlock:
    push ebp
    mov  ebp, esp
    push eax
    mov  eax, [esp + 12]

__pause_spinlock_entry:
    lock bts dword [eax], 0
    jc   __pause_spinlock_pause

    pop eax
    mov  esp, ebp
    pop  ebp
    ret

__pause_spinlock_pause:
    pause
    test  dword [eax], 1
    jnz   __pause_spinlock_pause
    jmp   __pause_spinlock_entry

;-------------------------------------------------------------------------------
; DATA
;-------------------------------------------------------------------------------

